<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App Test Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .chat-container {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
        }
        .message.sent {
            background-color: #d4edda;
            text-align: right;
        }
        .message.received {
            background-color: #d1ecf1;
        }
        .input-group {
            margin: 10px 0;
        }
        input, button {
            padding: 8px;
            margin: 5px;
        }
        .status {
            color: #666;
            font-style: italic;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Chat App Test Client</h1>
    
    <div>
        <h3>Authentication</h3>
        <div class="input-group">
            <input type="text" id="email" placeholder="Email" />
            <input type="password" id="password" placeholder="Password" />
            <button onclick="login()">Login</button>
            <button onclick="register()">Register</button>
        </div>
        <div id="authStatus" class="status"></div>
    </div>

    <div id="chatSection" style="display: none;">
        <h3>Chat</h3>
        <div class="input-group">
            <input type="text" id="receiverId" placeholder="Receiver User ID" />
            <input type="text" id="messageContent" placeholder="Message" />
            <button onclick="sendPrivateMessage()">Send Private Message</button>
        </div>
        
        <div class="input-group">
            <input type="text" id="roomName" placeholder="Room Name" />
            <button onclick="joinRoom()">Join Room</button>
            <button onclick="leaveRoom()">Leave Room</button>
        </div>
        
        <div class="input-group">
            <input type="text" id="roomMessageContent" placeholder="Room Message" />
            <button onclick="sendRoomMessage()">Send Room Message</button>
        </div>

        <div class="chat-container">
            <h4>Messages</h4>
            <div id="messages"></div>
        </div>

        <div class="chat-container">
            <h4>Connection Status</h4>
            <div id="connectionStatus" class="status">Disconnected</div>
            <div id="onlineUsers"></div>
        </div>
    </div>

    <script>
        let connection;
        let token;

        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userName: email.split('@')[0],
                        email: email,
                        password: password
                    })
                });
                
                if (response.ok) {
                    document.getElementById('authStatus').innerHTML = 'Registration successful! Please login.';
                    document.getElementById('authStatus').className = 'status';
                } else {
                    const error = await response.text();
                    document.getElementById('authStatus').innerHTML = 'Registration failed: ' + error;
                    document.getElementById('authStatus').className = 'error';
                }
            } catch (error) {
                document.getElementById('authStatus').innerHTML = 'Error: ' + error.message;
                document.getElementById('authStatus').className = 'error';
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    token = result.token;
                    document.getElementById('authStatus').innerHTML = 'Login successful!';
                    document.getElementById('authStatus').className = 'status';
                    document.getElementById('chatSection').style.display = 'block';
                    connectToSignalR();
                } else {
                    const error = await response.text();
                    document.getElementById('authStatus').innerHTML = 'Login failed: ' + error;
                    document.getElementById('authStatus').className = 'error';
                }
            } catch (error) {
                document.getElementById('authStatus').innerHTML = 'Error: ' + error.message;
                document.getElementById('authStatus').className = 'error';
            }
        }

        function connectToSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chathub", { accessTokenFactory: () => token })
                .build();

            // Connection events
            connection.onclose(() => {
                document.getElementById('connectionStatus').innerHTML = 'Disconnected';
                document.getElementById('connectionStatus').className = 'error';
            });

            connection.start()
                .then(() => {
                    document.getElementById('connectionStatus').innerHTML = 'Connected to SignalR Hub';
                    document.getElementById('connectionStatus').className = 'status';
                })
                .catch(err => {
                    document.getElementById('connectionStatus').innerHTML = 'Connection failed: ' + err;
                    document.getElementById('connectionStatus').className = 'error';
                });

            // Message events
            connection.on("ReceivePrivateMessage", (message) => {
                addMessage(message, 'received');
            });

            connection.on("ReceiveRoomMessage", (message) => {
                addMessage(message, 'received');
            });

            connection.on("MessageSent", (message) => {
                addMessage(message, 'sent');
            });

            connection.on("UserConnected", (userId, userName) => {
                addStatusMessage(`User ${userName} (${userId}) connected`);
            });

            connection.on("UserDisconnected", (userId) => {
                addStatusMessage(`User ${userId} disconnected`);
            });

            connection.on("UserJoinedRoom", (userId, userName, roomName) => {
                addStatusMessage(`User ${userName} joined room ${roomName}`);
            });

            connection.on("UserLeftRoom", (userId, userName, roomName) => {
                addStatusMessage(`User ${userName} left room ${roomName}`);
            });

            connection.on("Error", (error) => {
                addStatusMessage(`Error: ${error}`, true);
            });
        }

        async function sendPrivateMessage() {
            const receiverId = document.getElementById('receiverId').value;
            const content = document.getElementById('messageContent').value;
            
            if (!receiverId || !content) {
                alert('Please enter receiver ID and message content');
                return;
            }

            try {
                await connection.invoke("SendPrivateMessage", receiverId, content);
                document.getElementById('messageContent').value = '';
            } catch (error) {
                addStatusMessage(`Failed to send message: ${error}`, true);
            }
        }

        async function joinRoom() {
            const roomName = document.getElementById('roomName').value;
            
            if (!roomName) {
                alert('Please enter room name');
                return;
            }

            try {
                await connection.invoke("JoinRoom", roomName);
                addStatusMessage(`Joined room: ${roomName}`);
            } catch (error) {
                addStatusMessage(`Failed to join room: ${error}`, true);
            }
        }

        async function leaveRoom() {
            const roomName = document.getElementById('roomName').value;
            
            if (!roomName) {
                alert('Please enter room name');
                return;
            }

            try {
                await connection.invoke("LeaveRoom", roomName);
                addStatusMessage(`Left room: ${roomName}`);
            } catch (error) {
                addStatusMessage(`Failed to leave room: ${error}`, true);
            }
        }

        async function sendRoomMessage() {
            const content = document.getElementById('roomMessageContent').value;
            
            if (!content) {
                alert('Please enter message content');
                return;
            }

            try {
                await connection.invoke("SendMessageToRoom", document.getElementById('roomName').value, content);
                document.getElementById('roomMessageContent').value = '';
            } catch (error) {
                addStatusMessage(`Failed to send room message: ${error}`, true);
            }
        }

        function addMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const timestamp = new Date(message.timestamp).toLocaleTimeString();
            const senderName = message.senderName || message.senderId;
            
            messageDiv.innerHTML = `
                <strong>${senderName}</strong> (${timestamp})<br>
                ${message.content}
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addStatusMessage(message, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isError ? 'error' : 'status'}`;
            messageDiv.innerHTML = `<em>${message}</em>`;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html> 